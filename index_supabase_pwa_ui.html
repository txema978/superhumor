<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Superhumor (Supabase) ‚Äî PWA UI</title>
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root { --bg:#0b0f19; --card:#0f1628; --text:#e5e7eb; --muted:#9ca3af; --brand:#2563eb; --green:#16a34a; --red:#dc2626; --border:#1f2937; }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg)}
    .wrap{max-width:1100px;margin:20px auto;padding:0 16px}
    .header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .title{font-size:clamp(20px,3vw,26px);font-weight:800;letter-spacing:-.02em;margin:0}
    .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:12px}
    .stat{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .stat b{font-size:22px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    .row{display:flex;gap:12px;align-items:center}
    .seg{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .btn{border:1px solid var(--border);background:#0b1220;padding:8px 12px;border-radius:10px;cursor:pointer;color:var(--text)}
    .btn:hover{border-color:#334155}
    .btn.brand{background:var(--brand);color:#fff;border-color:transparent}
    .btn.green{background:var(--green);color:#fff;border-color:transparent}
    .btn.red{background:var(--red);color:#fff;border-color:transparent}
    .seg .btn{padding:6px 10px;font-size:14px}
    .seg .btn.active{background:var(--brand);color:#fff;border-color:transparent}
    .small{font-size:12px;color:var(--muted)}
    input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);outline:0;background:#0b1220;color:var(--text)}
    input[type="text"]:focus{border-color:#334155}
    .results{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin:12px 0}
    .badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0b1220;color:#9ca3af}
    .badge.ok{border-color:#166534;color:#a7f3d0;background:#052e1a}
    .badge.no{border-color:#7f1d1d;color:#fecaca;background:#2a0b0b}
    .cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media(max-width:960px){.cards{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:640px){.cards{grid-template-columns:1fr}}
    .progress{background:#1f2937;border-radius:999px;height:10px;overflow:hidden}
    .progress>div{height:100%;background:linear-gradient(90deg,#22c55e,#16a34a);width:0%;transition:width .3s ease}
    .center{text-align:center}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;padding:20px}
    .modal>div{position:relative;max-width:90vw;max-height:90vh}
    .modal img{max-width:90vw;max-height:90vh;border-radius:12px;display:block}
    .close{position:absolute;right:8px;top:8px}
    .img-frame{position:relative;width:100%;background:#0b1220;border:1px dashed #334155;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .img-frame img{max-width:100%;max-height:100%;object-fit:contain;display:block}
    .cover-spine{display:flex;gap:6px;align-items:stretch}
    .cover-col{flex:1 1 220px;min-width:180px;display:flex;flex-direction:column}
    .spine-col{flex:0 0 50px;width:50px;display:flex;flex-direction:column}
    .cover-col .img-frame{aspect-ratio:3/4;width:100%}
    .spine-col .img-frame{height:100%;width:100%}
    .thumb-tools{position:absolute;right:6px;top:6px;display:flex;gap:6px}
    .pill{font-size:12px;border:1px solid #334155;border-radius:999px;padding:3px 8px;color:#9ca3af}
    .debug{margin-left:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1 class="title">Superhumor (Supabase) <span class="pill" id="pill-mode">ESM</span><span class="pill debug" id="pill-debug" style="display:none">DEBUG</span></h1>
    </div>

    <div class="card" style="margin-bottom:10px">
      <div class="row">
        <input id="in-busqueda" type="text" placeholder="Buscar tomos por n√∫mero (p. ej. 5, 12, 30-33)" />
        <button class="btn brand" id="btn-buscar">Buscar</button>
      </div>
    </div>

    <div class="grid3">
      <div class="stat"><div class="small">Tomos que tienes</div><b id="st-tengo">0</b></div>
      <div class="stat"><div class="small">Tomos que faltan</div><b id="st-faltan">67</b></div>
      <div class="stat"><div class="small">Completado</div><b id="st-pct">0%</b></div>
    </div>

    <div id="box-resultados" class="results" style="display:none">
      <div class="row" style="justify-content:space-between">
        <h4 style="margin:0" id="res-title">Resultados</h4>
        <button class="btn" id="btn-cerrar-res">‚úñ Cerrar</button>
      </div>
      <div id="res-cards" class="cards" style="margin-top:10px"></div>
    </div>

    <div class="seg">
      <button class="btn active" data-filtro="todos">Todos (67)</button>
      <button class="btn" data-filtro="tengo">Que tengo (0)</button>
      <button class="btn" data-filtro="faltan">Que me faltan (67)</button>
    </div>

    <div id="cards" class="cards"></div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <span class="small">Progreso de la colecci√≥n</span>
        <span class="small" id="st-cont">0 de 67 tomos</span>
      </div>
      <div class="progress"><div id="bar" style="width:0%"></div></div>
    </div>
  </div>

  <!-- 1) Carga env si existe -->
  <script src=".env.js"></script>
  <!-- 2) Supabase CDN v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== Config ======
    const SUPABASE_URL  = (window.__ENV && window.__ENV.SUPABASE_URL)  || "";
    const SUPABASE_ANON = (window.__ENV && window.__ENV.SUPABASE_ANON_KEY) || "";
    const STORAGE_BUCKET = "imagenes";
    const STORAGE_ROOT = "uploads";

    const supa = (SUPABASE_URL && SUPABASE_ANON) ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON) : null;
    if(!supa){
      alert("Falta configurar .env.js con SUPABASE_URL y SUPABASE_ANON_KEY");
    }

    // ====== Estado (tengo/comentarios) en localStorage ======
    const LS_KEY = "superhumor_tengo_v1";
    function loadTengo(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY)) || {}; }catch(e){ return {}; }
    }
    function saveTengo(map){ localStorage.setItem(LS_KEY, JSON.stringify(map)); }
    const tengoMap = loadTengo();

    const state = { tomos: [], filtro: "todos", busqueda: "" };

    function $(sel, el){ return (el||document).querySelector(sel); }

    // ====== Helpers UI ======
    function stats(){
      let tengo = 0;
      for(const t of state.tomos){ if(t && tengoMap[t.id]) tengo++; }
      return { tengo, faltan: 67 - tengo, pct: Math.round((tengo/67)*100) };
    }
    function renderStats(){
      const s = stats();
      $("#st-tengo").textContent = s.tengo;
      $("#st-faltan").textContent = s.faltan;
      $("#st-pct").textContent = s.pct + "%";
      $("#st-cont").textContent = s.tengo + " de 67 tomos";
      const seg = document.querySelectorAll(".seg .btn");
      seg.forEach(b => {
        const f = b.getAttribute("data-filtro");
        b.classList.toggle("active", f===state.filtro);
        if (f==="tengo") b.textContent = `Que tengo (${s.tengo})`;
        if (f==="faltan") b.textContent = `Que me faltan (${s.faltan})`;
      });
      $("#bar").style.width = (s.tengo/67*100).toFixed(2)+"%";
    }

    function cardHTML(tomo){
      const num = tomo.id;
      const tengo = !!tengoMap[num];
      let html = "";
      html += `<div class="card" data-num="${num}">`;
      html += `<h3 style="margin-top:0">Tomo ${num}</h3>`;
      html += `<div class="row" style="gap:8px">`;
      html += `<button class="btn ${tengo?'green':''}" data-action="toggle">${tengo?'‚úì Lo tengo':'Marcar como tengo'}</button>`;
      html += `<span class="badge ${tengo?'ok':'no'}">${tengo?'‚úì LO TIENES':'‚úó TE FALTA'}</span>`;
      html += `</div>`;

      if (tengo){
        html += `<div class="cover-spine" style="margin-top:8px">`;

        // Portada
        html += `<div class="cover-col"><div class="small" style="margin:6px 0">Portada (completa)</div>`;
        html += `<div class="img-frame js-cover-frame">`;
        html += `<div class="thumb-tools">`;
        html += `<button class="btn" data-action="ver-portada">üëÅÔ∏è</button>`;
        html += `<button class="btn red" data-action="eliminar-portada">üóëÔ∏è</button>`;
        html += `</div>`;
        if (tomo.portada_url){
          html += `<img class="js-cover-img" src="${tomo.portada_url}" alt="Portada tomo ${num}"/>`;
        }else{
          html += `<label style="cursor:pointer"><input type="file" accept="image/*" style="display:none" data-action="subir-portada"/><div class="center" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:8px;color:#9ca3af;"><span>üì∑</span><span>Subir portada</span></div></label>`;
        }
        html += `</div></div>`;

        // Lomo
        html += `<div class="spine-col"><div class="small" style="margin:6px 0">Lomo</div>`;
        html += `<div class="img-frame js-spine-frame">`;
        html += `<div class="thumb-tools">`;
        html += `<button class="btn" data-action="ver-lomo">üëÅÔ∏è</button>`;
        html += `<button class="btn red" data-action="eliminar-lomo">üóëÔ∏è</button>`;
        html += `</div>`;
        if (tomo.lomo_url){
          html += `<img class="js-spine-img" src="${tomo.lomo_url}" alt="Lomo tomo ${num}"/>`;
        }else{
          html += `<label style="cursor:pointer"><input type="file" accept="image/*" style="display:none" data-action="subir-lomo"/><div class="center" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:8px;color:#9ca3af;"><span>üì∑</span><span>Subir lomo</span></div></label>`;
        }
        html += `</div></div>`;

        html += `</div>`; // cover-spine
      }

      // Comentario local (igual que antes)
      const c = (tomo.__comentario || "");
      html += `<div style="margin-top:10px"><div class="small" style="margin-bottom:6px">Comentario</div>`;
      if (tomo.__editando){
        const safe = c.replace(/[&<>]/g,'');
        html += `<textarea data-editable="textarea">${safe}</textarea><div class="row" style="gap:8px;margin-top:6px"><button class="btn brand" data-action="guardar-comentario">üíæ Guardar</button><button class="btn" data-action="cancelar-comentario">Cancelar</button></div>`;
      }else{
        const safe2 = c ? c.replace(/[&<>]/g,'') : '';
        html += `<div class="small" data-action="editar-comentario" style="cursor:pointer;${c?'white-space:pre-wrap':''}">${ safe2 || '<span style="font-style:italic;color:#6b7280">Haz clic para a√±adir comentario‚Ä¶</span>' }</div>`;
      }
      html += `</div></div>`;
      return html;
    }

    function render(){
      renderStats();
      let html = "";
      for(const t of state.tomos){
        if(!t) continue;
        if (state.filtro==='tengo' && !tengoMap[t.id]) continue;
        if (state.filtro==='faltan' && tengoMap[t.id]) continue;
        html += cardHTML(t);
      }
      $("#cards").innerHTML = html;
      setTimeout(syncSpineHeights, 0);
    }

    function buscar(){
      const nums = parseBusqueda(state.busqueda);
      const box = $("#box-resultados");
      if(!nums.length){ $("#res-cards").innerHTML=""; box.style.display="none"; return; }
      let html="";
      for(const n of nums){
        const t = state.tomos.find(x => x && x.id===n);
        if(t) html += cardHTML(t);
      }
      $("#res-title").textContent = `Resultados de b√∫squeda (${nums.length} tomos)`;
      $("#res-cards").innerHTML = html;
      box.style.display="block";
      setTimeout(syncSpineHeights, 0);
    }

    function parseBusqueda(text){
      const parts = text.split(/[,\s]+/);
      const out = []; const used = {};
      for(const raw of parts){
        const p = (raw||"").trim(); if(!p) continue;
        if(/^\d+-\d+$/.test(p)){
          const [a,b] = p.split("-").map(n=>parseInt(n,10));
          if(!isNaN(a)&&!isNaN(b)&&a<=b){
            for(let n=a;n<=b;n++){ if(n>=1&&n<=67 && !used[n]){ out.push(n); used[n]=1; } }
          }
        }else if(/^\d+$/.test(p)){
          const n = parseInt(p,10); if(n>=1&&n<=67 && !used[n]){ out.push(n); used[n]=1; }
        }
      }
      out.sort((a,b)=>a-b);
      return out;
    }

    function syncSpineHeights(){
      document.querySelectorAll(".cover-spine").forEach(pair => {
        const cover = pair.querySelector(".cover-col .js-cover-frame");
        const spine = pair.querySelector(".spine-col .js-spine-frame");
        if(!cover || !spine) return;
        spine.style.height="auto";
        const h = cover.getBoundingClientRect().height;
        if (h>0) spine.style.height = h+"px";
      });
    }

    // ====== Eventos globales ======
    document.addEventListener("click", async (e)=>{
      const actionEl = e.target.closest("[data-action]");
      const card = e.target.closest(".card[data-num]");
      const num = card ? parseInt(card.getAttribute("data-num"),10) : null;

      if(actionEl && num){
        const action = actionEl.getAttribute("data-action");
        const tomo = state.tomos.find(t => t && t.id===num);
        if(!tomo) return;

        if(action==="toggle"){
          tengoMap[num] = !tengoMap[num];
          saveTengo(tengoMap);
          render();
          return;
        }
        if(action==="ver-portada" && tomo.portada_url){ showModal(tomo.portada_url); return; }
        if(action==="ver-lomo" && tomo.lomo_url){ showModal(tomo.lomo_url); return; }
        if(action==="eliminar-portada"){ await borrarImagenEnDB(num,"portada_url", tomo.portada_url); tomo.portada_url=null; render(); return; }
        if(action==="eliminar-lomo"){ await borrarImagenEnDB(num,"lomo_url", tomo.lomo_url); tomo.lomo_url=null; render(); return; }
        if(action==="editar-comentario"){ tomo.__editando=true; render(); return; }
        if(action==="guardar-comentario"){
          const ta = card.querySelector('[data-editable="textarea"]');
          tomo.__comentario = ta.value; tomo.__editando=false; render(); return;
        }
        if(action==="cancelar-comentario"){ tomo.__editando=false; render(); return; }
      }

      const filtroBtn = e.target.closest("[data-filtro]");
      if(filtroBtn){ state.filtro = filtroBtn.getAttribute("data-filtro"); document.querySelectorAll(".seg .btn").forEach(b=>b.classList.remove("active")); filtroBtn.classList.add("active"); render(); }
      if(e.target.closest("#btn-cerrar-res")){ $("#box-resultados").style.display="none"; $("#res-cards").innerHTML=""; }
      if(e.target.closest("#btn-buscar")) buscar();
    });

    document.addEventListener("change", async (e)=>{
      const input = e.target.closest('input[type="file"][data-action]');
      if(!input) return;
      const card = e.target.closest(".card[data-num]");
      const num = card ? parseInt(card.getAttribute("data-num"),10) : null;
      const act = input.getAttribute("data-action");
      const file = input.files && input.files[0];
      if(!(num && file && file.type && file.type.indexOf("image/")===0)) return;

      const isPortada = (act==="subir-portada");
      const path = `${STORAGE_ROOT}/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9_\.-]/g,'_')}`;
      const { data, error } = await supa.storage.from(STORAGE_BUCKET).upload(path, file, { cacheControl: "3600", upsert: false });
      if(error){ alert("Error subiendo imagen: "+error.message); return; }
      const pub = supa.storage.from(STORAGE_BUCKET).getPublicUrl(path).data.publicUrl;
      const field = isPortada ? "portada_url" : "lomo_url";
      const { error:upErr } = await supa.from("tomos").update({ [field]: pub }).eq("id", num);
      if(upErr){ alert("Error guardando URL en DB: "+upErr.message); return; }
      const tomo = state.tomos.find(t => t && t.id===num);
      if(tomo){ if(isPortada) tomo.portada_url=pub; else tomo.lomo_url=pub; render(); }
    });

    $("#in-busqueda").addEventListener("input", (e)=>{ state.busqueda = e.target.value; });
    $("#in-busqueda").addEventListener("keydown", (e)=>{ if(e.key==="Enter") buscar(); });

    function showModal(src){
      const m=document.createElement("div"); m.className="modal"; m.innerHTML='<div><button class="btn close">‚úñ</button><img src="'+src+'" alt="Imagen"/></div>';
      m.addEventListener("click", ()=> m.remove());
      document.body.appendChild(m);
    }

    // ====== Supabase helpers ======
    async function borrarImagenEnDB(id, field, url){
      try{
        // Borrar objeto en el bucket si pertenece al bucket p√∫blico
        if(url && url.includes("/storage/v1/object/public/"+STORAGE_BUCKET+"/")){
          const idx = url.indexOf("/storage/v1/object/public/"+STORAGE_BUCKET+"/");
          const path = url.slice(idx + ("/storage/v1/object/public/".length + STORAGE_BUCKET.length + 1));
          await supa.storage.from(STORAGE_BUCKET).remove([path]);
        }
      }catch(_){}
      await supa.from("tomos").update({ [field]: null }).eq("id", id);
    }

    // ====== Carga inicial ======
    async function loadTomos(){
      const { data, error } = await supa.from("tomos").select("id,titulo,portada_url,lomo_url").order("id", { ascending:true }).limit(67);
      if(error){ alert("Error cargando tomos: "+error.message); return; }
      const arr = new Array(68);
      (data||[]).forEach(row => { arr[row.id] = row; });
      // Asegurar 1..67
      for(let i=1;i<=67;i++){ if(!arr[i]) arr[i] = { id:i, titulo:`Super Humor n¬∫${i}`, portada_url:null, lomo_url:null }; }
      state.tomos = arr.slice(1);
      render();
    }

    loadTomos().then(()=>renderStats());

  </script>
</body>
</html>
