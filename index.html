<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Super Humor PWA - v4.0-supabase</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
    header { background: #333; color: #fff; padding: 10px; text-align: center; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(150px,1fr)); gap: 10px; padding: 10px; }
    .tomo { background: #fff; padding: 10px; border-radius: 6px; text-align: center; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    img { max-width: 100%; height: auto; border-radius: 4px; }
    button { margin-top: 5px; display: block; width: 100%; padding: 6px; background: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0056b3; }
    #login { position: fixed; top: 10px; right: 10px; background: #ff5722; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h1>Super Humor Tomos</h1>
    <p>Versión v4.0-supabase</p>
  </header>

  <button id="login">Editar</button>
  <div class="grid" id="tomos"></div>

  <script>
    const supabaseUrl = "https://qjmugmnrgxccliyrlwfz.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."; // sustituir por tu anon key real
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    let loggedIn = false;

    document.getElementById("login").onclick = async () => {
      if (!loggedIn) {
        const email = prompt("Email:");
        const password = prompt("Contraseña:");
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) { alert("Error de login: " + error.message); return; }
        loggedIn = true;
        alert("Login correcto");
        renderTomos();
      }
    };

    async function renderTomos() {
      const container = document.getElementById("tomos");
      container.innerHTML = "";
      const { data, error } = await supabaseClient.from("tomos").select("*").order("numero", { ascending: true });
      if (error) { container.innerHTML = "Error cargando tomos"; return; }
      data.forEach(tomo => {
        const div = document.createElement("div");
        div.className = "tomo";
        div.innerHTML = `
          <h3>Tomo ${tomo.numero}</h3>
          ${tomo.portada ? `<img src="${tomo.portada}" alt="Portada">` : "<p>Sin portada</p>"}
          ${tomo.lomo ? `<img src="${tomo.lomo}" alt="Lomo">` : "<p>Sin lomo</p>"}
        `;
        if (loggedIn) {
          const btnPortada = document.createElement("button");
          btnPortada.innerText = "Subir Portada";
          btnPortada.onclick = () => uploadImage(tomo.id, "portada");
          div.appendChild(btnPortada);

          const btnLomo = document.createElement("button");
          btnLomo.innerText = "Subir Lomo";
          btnLomo.onclick = () => uploadImage(tomo.id, "lomo");
          div.appendChild(btnLomo);
        }
        container.appendChild(div);
      });
    }

    async function uploadImage(tomoId, field) {
      const file = document.createElement("input");
      file.type = "file";
      file.accept = "image/*";
      file.onchange = async () => {
        const img = file.files[0];
        if (!img) return;
        const path = `uploads/${Date.now()}_${img.name}`;
        let { data, error } = await supabaseClient.storage.from("imagenes").upload(path, img, { upsert: true });
        if (error) { alert("Error subiendo: " + error.message); return; }
        const publicUrl = supabaseClient.storage.from("imagenes").getPublicUrl(path).data.publicUrl;
        await supabaseClient.from("tomos").update({ [field]: publicUrl }).eq("id", tomoId);
        renderTomos();
      };
      file.click();
    }

    renderTomos();
  </script>
</body>
</html>
