<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Colecci√≥n Superhumor ‚Äî PWA (v3.4)</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="theme-color" content="#2563eb">
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#1f2937; --muted:#6b7280; --brand:#2563eb; --green:#16a34a; --red:#dc2626; --border:#e5e7eb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg)}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .header{background:linear-gradient(90deg,#2563eb,#1e40af);color:#fff;border-radius:14px;padding:16px;display:flex;align-items:center;gap:12px}
    .title{font-size:clamp(20px,3vw,26px);font-weight:800;letter-spacing:-.02em;margin:0}
    .sub{margin:2px 0 0;color:#e5e7eb}
    .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:12px}
    .stat{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .stat b{font-size:22px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    .row{display:flex;gap:12px;align-items:center}
    .seg{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .btn{border:1px solid var(--border);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:#cbd5e1}
    .btn.brand{background:var(--brand);color:#fff;border-color:transparent}
    .btn.green{background:var(--green);color:#fff;border-color:transparent}
    .btn.red{background:var(--red);color:#fff;border-color:transparent}
    .seg .btn{padding:6px 10px;font-size:14px}
    .seg .btn.active{background:var(--brand);color:#fff;border-color:transparent}
    .small{font-size:12px;color:var(--muted)}
    input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);outline:0}
    input[type="text"]:focus{border-color:#cbd5e1}
    .results{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin:12px 0}
    .badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;color:#6b7280}
    .badge.ok{border-color:#86efac;color:#166534;background:#f0fdf4}
    .badge.no{border-color:#fecaca;color:#7f1d1d;background:#fef2f2}
    .cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media(max-width:960px){.cards{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:640px){.cards{grid-template-columns:1fr}}
    .progress{background:#e5e7eb;border-radius:999px;height:10px;overflow:hidden}
    .progress>div{height:100%;background:linear-gradient(90deg,#22c55e,#16a34a);width:0%;transition:width .3s ease}
    .center{text-align:center}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;padding:20px}
    .modal>div{position:relative;max-width:90vw;max-height:90vh}
    .modal img{max-width:90vw;max-height:90vh;border-radius:12px;display:block}
    .close{position:absolute;right:8px;top:8px}

    .img-frame{position:relative;width:100%;background:#f9fafb;border:1px dashed #d1d5db;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .img-frame img{max-width:100%;max-height:100%;object-fit:contain;display:block}

    .cover-spine{display:flex;gap:6px;align-items:stretch}
    .cover-col{flex:1 1 220px;min-width:180px;display:flex;flex-direction:column}
    .spine-col{flex:0 0 50px;width:50px;display:flex;flex-direction:column}
    .cover-col .img-frame{aspect-ratio:3/4;width:100%}
    .spine-col .img-frame{height:100%;width:100%}

    .thumb-tools{position:absolute;right:6px;top:6px;display:flex;gap:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div style="font-size:26px">üìö</div>
      <div>
        <h1 class="title">Colecci√≥n Superhumor</h1>
        <div class="sub">Gestiona tu colecci√≥n completa de 67 tomos ‚Äî v3.4</div>
      </div>
    </div>

    <div class="grid3">
      <div class="stat"><div class="small">Tomos que tienes</div><b id="st-tengo">0</b></div>
      <div class="stat"><div class="small">Tomos que faltan</div><b id="st-faltan">67</b></div>
      <div class="stat"><div class="small">Completado</div><b id="st-pct">0%</b></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row">
        <input id="in-busqueda" type="text" placeholder="Escribe n√∫meros (ej: 5, 12, 23-25, 30)"/>
        <button class="btn brand" id="btn-buscar">Buscar</button>
      </div>
      <div class="small">Puedes buscar uno o varios n√∫meros separados por comas, espacios o guiones.</div>
    
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;flex-wrap:wrap;gap:8px">
        <div class="small">Sincronizaci√≥n entre dispositivos (opcional)</div>
        <div class="row" style="gap:8px">
          <button class="btn" id="btn-sync-setup">Configurar</button>
          <button class="btn brand" id="btn-sync-push">Guardar en la nube</button>
          <button class="btn" id="btn-sync-pull">Traer de la nube</button>
        </div>
      </div>
      <div class="small" id="sync-status" style="margin-top:6px;color:#6b7280"></div>
    </div>

    <div id="sync-modal" class="modal" style="display:none">
      <div style="max-width:520px">
        <button class="btn close">‚úñ</button>
        <div class="card" style="padding:16px">
          <h3 style="margin-top:0">Configurar sincronizaci√≥n</h3>
          <div class="small" style="margin-bottom:8px">
            Necesitas un <b>Gist secreto</b> en GitHub y un <b>token</b> con permiso <code>gist</code>. Nada m√°s.
          </div>
          <label class="small">Gist ID</label>
          <input id="gist-id" type="text" placeholder="p.ej. a1b2c3d4e5f6..." style="margin:6px 0 12px 0;width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px"/>
          <label class="small">Token (solo scope: gist)</label>
          <input id="gist-token" type="password" placeholder="ghp_xxxxxxxxxxxxxxxxx" style="margin:6px 0 12px 0;width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px"/>
          <div class="row" style="justify-content:flex-end;gap:8px">
            <button class="btn" id="btn-sync-cancel">Cancelar</button>
            <button class="btn brand" id="btn-sync-save">Guardar</button>
          </div>
        </div>
      </div>
    </div>
</div>

    <div id="box-resultados" class="results" style="display:none">
      <div class="row" style="justify-content:space-between">
        <h4 style="margin:0" id="res-title">Resultados de b√∫squeda</h4>
        <button class="btn" id="btn-cerrar-res">‚úñ Cerrar</button>
      </div>
      <div id="res-cards" class="cards" style="margin-top:10px"></div>
    </div>

    <div class="seg">
      <button class="btn active" data-filtro="todos">Todos (67)</button>
      <button class="btn" data-filtro="tengo">Que tengo (0)</button>
      <button class="btn" data-filtro="faltan">Que me faltan (67)</button>
    </div>

    <div id="cards" class="cards"></div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <span class="small">Progreso de la colecci√≥n</span>
        <span class="small" id="st-cont">0 de 67 tomos</span>
      </div>
      <div class="progress"><div id="bar" style="width:0%"></div></div>
    </div>
  </div>

  <script>
    // SW v33
    if ('serviceWorker' in navigator) { window.addEventListener('load', function(){ navigator.serviceWorker.register('./service-worker-v34.js').catch(function(){}); }); }

    function $(sel, el){ return (el||document).querySelector(sel); }

    function parseBusqueda(text){
      var parts = text.split(/[,\s]+/);
      var out = []; var used = {};
      for (var i=0;i<parts.length;i++){
        var p = parts[i].trim(); if (!p) continue;
        if (/^\d+-\d+$/.test(p)){
          var ab = p.split('-'); var a = parseInt(ab[0],10), b = parseInt(ab[1],10);
          if (!isNaN(a)&&!isNaN(b)&&a<=b){ for (var n=a;n<=b;n++){ if (n>=1&&n<=67 && !used[n]){ out.push(n); used[n]=1; } } }
        } else if (/^\d+$/.test(p)){
          var n = parseInt(p,10); if (n>=1&&n<=67 && !used[n]){ out.push(n); used[n]=1; }
        }
      }
      out.sort(function(a,b){return a-b;});
      return out;
    }

    var STORAGE_KEY = 'superhumor_v2';
    var state = { tomos:[], filtro:'todos', busqueda:'', resultados:[] };

    function emptyTomo(){ return { tengo:false, comentario:'', portada:null, lomo:null }; }

    function ensure67(arr){
      if (!arr || !arr.length){ arr = new Array(68); }
      for (var i=1;i<=67;i++){ if (!arr[i]) arr[i] = emptyTomo(); }
      return arr;
    }

    function load(){
      try{
        var raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        var parsed = JSON.parse(raw);
        return parsed && parsed.tomos ? parsed.tomos : null;
      }catch(e){ return null; }
    }

    function save(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({ tomos: state.tomos })); }catch(e){}
    }

    function init(){
      var saved = load();
      state.tomos = ensure67(saved);
      save();
      render();
      syncSpineHeights();
    }

    function stats(){
      var tengo=0;
      for (var i=1;i<=67;i++){ if (state.tomos[i] && state.tomos[i].tengo) tengo++; }
      return { tengo:tengo, faltan:67-tengo, pct: Math.round((tengo/67)*100) };
    }

    function renderStats(){
      var s = stats();
      $('#st-tengo').textContent = s.tengo;
      $('#st-faltan').textContent = s.faltan;
      $('#st-pct').textContent = s.pct + '%';
      $('#st-cont').textContent = s.tengo + ' de 67 tomos';
      var seg = document.querySelectorAll('.seg .btn');
      for (var i=0;i<seg.length;i++){
        var f = seg[i].getAttribute('data-filtro');
        seg[i].classList.toggle('active', f === state.filtro);
        if (f==='tengo') seg[i].textContent = 'Que tengo ('+s.tengo+')';
        if (f==='faltan') seg[i].textContent = 'Que me faltan ('+s.faltan+')';
      }
      $('#bar').style.width = (s.tengo/67*100).toFixed(2)+'%';
    }

    function cardHTML(num, tomo){
      var html = '';
      html += '<div class="card" data-num="'+num+'">';
      html += '<h3 style="margin-top:0">Tomo '+num+'</h3>';
      html += '<div class="row" style="gap:8px">';
      html += '<button class="btn '+(tomo.tengo?'green':'')+'" data-action="toggle">'+(tomo.tengo?'‚úì Lo tengo':'Marcar como tengo')+'</button>';
      html += '<span class="badge '+(tomo.tengo?'ok':'no')+'">'+(tomo.tengo?'‚úì LO TIENES':'‚úó TE FALTA')+'</span>';
      html += '</div>';

      if (tomo.tengo){
        html += '<div class="cover-spine" style="margin-top:8px">';
        html += '<div class="cover-col"><div class="small" style="margin:6px 0">Portada (completa)</div>';
        if (tomo.portada){
          html += '<div class="img-frame js-cover-frame"><img class="js-cover-img" src="'+tomo.portada+'" alt="Portada tomo '+num+'"/><div class="thumb-tools"><button class="btn" data-action="ver-portada">üëÅÔ∏è</button><button class="btn red" data-action="eliminar-portada">üóëÔ∏è</button></div></div>';
        } else {
          html += '<label class="img-frame js-cover-frame" style="cursor:pointer"><input type="file" accept="image/*" style="display:none" data-action="subir-portada"/><div class="center" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:8px;color:#6b7280;"><span>üì∑</span><span>Subir portada</span></div></label>';
        }
        html += '</div>';
        html += '<div class="spine-col"><div class="small" style="margin:6px 0">Lomo</div>';
        if (tomo.lomo){
          html += '<div class="img-frame js-spine-frame"><img class="js-spine-img" src="'+tomo.lomo+'" alt="Lomo tomo '+num+'"/><div class="thumb-tools"><button class="btn" data-action="ver-lomo">üëÅÔ∏è</button><button class="btn red" data-action="eliminar-lomo">üóëÔ∏è</button></div></div>';
        } else {
          html += '<label class="img-frame js-spine-frame" style="cursor:pointer"><input type="file" accept="image/*" style="display:none" data-action="subir-lomo"/><div class="center" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:8px;color:#6b7280;"><span>üì∑</span><span>Subir lomo</span></div></label>';
        }
        html += '</div></div>';
      }

      html += '<div style="margin-top:10px"><div class="small" style="margin-bottom:6px">Comentario</div><div data-editable="wrap">';
      if (tomo._editando){
        var safe = (tomo.comentario||'').replace(/[&<>]/g,'');
        html += '<textarea data-editable="textarea">'+safe+'</textarea><div class="row" style="gap:8px;margin-top:6px"><button class="btn brand" data-action="guardar-comentario">üíæ Guardar</button><button class="btn" data-action="cancelar-comentario">Cancelar</button></div>';
      } else {
        var safe2 = tomo.comentario ? tomo.comentario.replace(/[&<>]/g,'') : '';
        html += '<div class="small" data-action="editar-comentario" style="cursor:pointer;'+(tomo.comentario?'white-space:pre-wrap':'')+'">'+(safe2 || '<span style="font-style:italic;color:#9ca3af">Haz clic para a√±adir comentario‚Ä¶</span>')+'</div>';
      }
      html += '</div></div></div>';
      return html;
    }

    function render(){
      renderStats();
      var html = '';
      for (var i=1;i<=67;i++){
        var t = state.tomos[i];
        if (!t) continue;
        if (state.filtro==='tengo' && !t.tengo) continue;
        if (state.filtro==='faltan' && t.tengo) continue;
        html += cardHTML(i, t);
      }
      $('#cards').innerHTML = html;
      setTimeout(syncSpineHeights, 0);
    }

    function buscar(){
      var nums = parseBusqueda(state.busqueda);
      var box = $('#box-resultados');
      if (!nums.length){ state.resultados=[]; box.style.display='none'; return; }
      var html='';
      for (var i=0;i<nums.length;i++){
        var n = nums[i]; var t = state.tomos[n] || emptyTomo();
        html += cardHTML(n, t);
      }
      $('#res-title').textContent = 'Resultados de b√∫squeda ('+nums.length+' tomos)';
      $('#res-cards').innerHTML = html;
      box.style.display='block';
      setTimeout(syncSpineHeights, 0);
    }

    function syncSpineHeights(){
      var pairs = document.querySelectorAll('.cover-spine');
      for (var i=0;i<pairs.length;i++){
        var pair=pairs[i];
        var cover = pair.querySelector('.cover-col .js-cover-frame');
        var spine = pair.querySelector('.spine-col .js-spine-frame');
        if (!cover || !spine) continue;
        spine.style.height='auto';
        var h = cover.getBoundingClientRect().height;
        if (h>0) spine.style.height = h+'px';
      }
    }

    document.addEventListener('click', function(e){
      var actionEl = e.target.closest('[data-action]');
      var card = e.target.closest('.card[data-num]');
      var num = card ? parseInt(card.getAttribute('data-num'),10) : null;
      if (actionEl){
        var action = actionEl.getAttribute('data-action');
        if (action==='toggle' && num){ state.tomos[num].tengo = !state.tomos[num].tengo; save(); render(); return; }
        if (action==='ver-portada' && num){ var t=state.tomos[num]; if (t.portada) showModal(t.portada); return; }
        if (action==='eliminar-portada' && num){ state.tomos[num].portada=null; save(); render(); return; }
        if (action==='ver-lomo' && num){ var t2=state.tomos[num]; if (t2.lomo) showModal(t2.lomo); return; }
        if (action==='eliminar-lomo' && num){ state.tomos[num].lomo=null; save(); render(); return; }
        if (action==='editar-comentario' && num){ state.tomos[num]._editando=true; render(); return; }
        if (action==='guardar-comentario' && num){ var ta=card.querySelector('[data-editable="textarea"]'); state.tomos[num].comentario=ta.value; state.tomos[num]._editando=false; save(); render(); return; }
        if (action==='cancelar-comentario' && num){ state.tomos[num]._editando=false; render(); return; }
      }
      var filtroBtn = e.target.closest('[data-filtro]');
      if (filtroBtn){ state.filtro = filtroBtn.getAttribute('data-filtro'); var bs=document.querySelectorAll('.seg .btn'); for (var j=0;j<bs.length;j++) bs[j].classList.remove('active'); filtroBtn.classList.add('active'); render(); }
      if (e.target.closest('#btn-cerrar-res')){ $('#box-resultados').style.display='none'; state.resultados=[]; state.busqueda=''; $('#in-busqueda').value=''; }
      if (e.target.closest('#btn-buscar')){ buscar(); }
    });

    document.addEventListener('change', function(e){
      var input = e.target.closest('input[type="file"][data-action]');
      if (!input) return;
      var card = e.target.closest('.card[data-num]'); var num = card?parseInt(card.getAttribute('data-num'),10):null;
      var act = input.getAttribute('data-action');
      if (num && input.files && input.files[0] && input.files[0].type && input.files[0].type.indexOf('image/')===0){
        var reader = new FileReader();
        reader.onload = function(ev){ if (act==='subir-portada') state.tomos[num].portada=ev.target.result; if (act==='subir-lomo') state.tomos[num].lomo=ev.target.result; save(); render(); };
        reader.readAsDataURL(input.files[0]);
      }
    });

    $('#in-busqueda').addEventListener('input', function(e){ state.busqueda = e.target.value; });
    $('#in-busqueda').addEventListener('keydown', function(e){ if (e.key==='Enter') buscar(); });

    function showModal(src){
      var m=document.createElement('div'); m.className='modal'; m.innerHTML='<div><button class="btn close">‚úñ</button><img src="'+src+'" alt="Imagen"/></div>';
      m.addEventListener('click', function(){ m.remove(); });
      document.body.appendChild(m);
    }

    window.addEventListener('resize', function(){ setTimeout(syncSpineHeights, 0); });

    init();
    // --- Simple cloud sync via GitHub Gist ---
    var SYNC_FILE = 'superhumor.json';
    function syncStatus(msg){ var el=document.getElementById('sync-status'); if (el) el.textContent = msg||''; }
    function getSyncCfg(){
      return {
        id: localStorage.getItem('sh_sync_gist') || '',
        token: localStorage.getItem('sh_sync_token') || ''
      };
    }
    function setSyncCfg(id, token){
      localStorage.setItem('sh_sync_gist', id||'');
      localStorage.setItem('sh_sync_token', token||'');
    }
    function openSyncModal(show){
      var m=document.getElementById('sync-modal');
      if (!m) return;
      m.style.display = show?'flex':'none';
      if (show){
        var cfg=getSyncCfg();
        document.getElementById('gist-id').value = cfg.id;
        document.getElementById('gist-token').value = cfg.token;
      }
    }
    document.addEventListener('click', function(e){
      if (e.target.closest('#btn-sync-setup')){ openSyncModal(true); }
      if (e.target.closest('#sync-modal .close') || e.target.closest('#btn-sync-cancel')){ openSyncModal(false); }
      if (e.target.closest('#btn-sync-save')){
        var id = document.getElementById('gist-id').value.trim();
        var tk = document.getElementById('gist-token').value.trim();
        setSyncCfg(id, tk);
        openSyncModal(false);
        syncStatus('Configuraci√≥n guardada.');
      }
      if (e.target.closest('#btn-sync-push')){ pushToCloud(); }
      if (e.target.closest('#btn-sync-pull')){ pullFromCloud(); }
    });

    function headers(token){
      return {
        'Accept': 'application/vnd.github+json',
        'Authorization': 'Bearer ' + token
      };
    }

    function pushToCloud(){
      var cfg=getSyncCfg();
      if (!cfg.id || !cfg.token){ syncStatus('Falta configurar Gist ID y token.'); return; }
      syncStatus('Subiendo‚Ä¶');
      var payload = JSON.stringify({ updatedAt: new Date().toISOString(), tomos: state.tomos });
      fetch('https://api.github.com/gists/' + cfg.id, {
        method: 'PATCH',
        headers: Object.assign({'Content-Type':'application/json'}, headers(cfg.token)),
        body: JSON.stringify({ files: { } })
      }).then(function(res){
        if (res.status===404){
          // Gist no existe o no accesible
          syncStatus('No puedo acceder al Gist. Revisa el ID/token.');
          return Promise.reject();
        }
        return res.json();
      }).then(function(json){
        // Need filename; if doesn't exist, create. We'll PATCH again with the file content.
        var files = json.files || {};
        var patch = { files: {} };
        patch.files[SYNC_FILE] = { content: payload };
        return fetch('https://api.github.com/gists/' + cfg.id, {
          method:'PATCH',
          headers: Object.assign({'Content-Type':'application/json'}, headers(cfg.token)),
          body: JSON.stringify(patch)
        });
      }).then(function(res){
        if (!res) return;
        if (!res.ok) throw new Error('Error subiendo: '+res.status);
        syncStatus('Guardado en la nube ‚úÖ');
      }).catch(function(){ /* swallowed */ });
    }

    function pullFromCloud(){
      var cfg=getSyncCfg();
      if (!cfg.id || !cfg.token){ syncStatus('Falta configurar Gist ID y token.'); return; }
      syncStatus('Descargando‚Ä¶');
      fetch('https://api.github.com/gists/' + cfg.id, { headers: headers(cfg.token) })
        .then(function(res){ if (!res.ok) throw new Error('No puedo leer el Gist'); return res.json(); })
        .then(function(json){
          var files = json.files || {};
          if (!files[SYNC_FILE] || !files[SYNC_FILE].content){ syncStatus('El archivo '+SYNC_FILE+' no existe en el Gist.'); return; }
          var data = JSON.parse(files[SYNC_FILE].content);
          if (data && data.tomos){
            state.tomos = ensure67(data.tomos);
            save(); render();
            syncStatus('Datos descargados y aplicados ‚úÖ');
          } else {
            syncStatus('Formato inesperado en el Gist.');
          }
        }).catch(function(err){ syncStatus('Error leyendo el Gist.'); });
    }

  </script>
</body>
</html>
