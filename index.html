<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Superhumor · v4.2-supabase</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--fg:#e5e7eb;--accent:#2563eb;--ok:#16a34a;--warn:#7c3aed;--err:#ef4444}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;background:rgba(15,23,42,.9);backdrop-filter:saturate(140%) blur(6px);padding:12px 16px;border-bottom:1px solid #1f2937;z-index:5;display:flex;gap:12px;align-items:center}
    header h1{margin:0;font-size:18px;font-weight:700}
    header .search{flex:1;display:flex;gap:8px}
    header input[type=search]{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:var(--fg)}
    .container{padding:16px;max-width:1100px;margin:0 auto}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px}
    .thumbs{display:flex;gap:8px;align-items:flex-start}
    .thumbs img{background:#0b1220;border:1px solid #1f2937;border-radius:10px;max-height:260px;object-fit:contain}
    .thumbs img.portada{flex:1;min-width:0;width:100%}
    .thumbs img.lomo{width:64px}
    .title{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .title b{font-size:14px}
    .muted{color:var(--muted);font-size:12px}
    .adminbar{display:none;gap:6px}
    .btn{padding:7px 10px;border:1px solid #1f2937;border-radius:8px;background:#0b1220;color:var(--fg);cursor:pointer;font-weight:600}
    .btn.primary{background:var(--accent);border-color:#1d4ed8}
    .btn.warn{background:var(--warn);border-color:#6d28d9}
    .btn.err{background:var(--err);border-color:#b91c1c}
    .fab{position:fixed;right:16px;bottom:16px;padding:12px 14px;border-radius:999px;background:var(--accent);color:#fff;border:none;font-weight:800;cursor:pointer;z-index:10;box-shadow:0 12px 30px rgba(37,99,235,.35)}
    .panel{position:fixed;right:16px;bottom:76px;width:300px;background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:12px;box-shadow:0 12px 30px rgba(0,0,0,.35);display:none;z-index:11}
    .panel input{width:100%;margin:6px 0;padding:9px 10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:var(--fg)}
    .version{position:fixed;top:8px;right:10px;background:#0b1220;border:1px solid #1f2937;color:#9ca3af;border-radius:999px;padding:4px 8px;font-size:11px}
    .empty{border:1px dashed #334155;border-radius:10px;padding:20px;text-align:center;color:#64748b}
  </style>
</head>
<body>
  <span class="version">v4.2-supabase</span>
  <header>
    <h1>Superhumor (Supabase)</h1>
    <div class="search">
      <input id="q" type="search" placeholder="Buscar tomos por número (p. ej. 5, 12, 30-33)" />
      <button id="btnBuscar" class="btn">Buscar</button>
    </div>
  </header>

  <div class="container">
    <div id="status" class="muted" style="margin:6px 2px 12px"></div>
    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none">No hay tomos con ese filtro.</div>
  </div>

  <!-- Botón flotante de administración -->
  <button id="fab" class="fab">Editar</button>
  <div id="panel" class="panel">
    <div style="font-weight:700;margin-bottom:6px">Modo edición</div>
    <div id="admStatus" class="muted">No has iniciado sesión.</div>
    <input id="email" type="email" placeholder="tu email" value="txema978@gmail.com" />
    <input id="password" type="password" placeholder="tu contraseña" />
    <div style="display:flex;gap:8px">
      <button id="login" class="btn" style="flex:1;background:#16a34a;border-color:#15803d">Entrar</button>
      <button id="logout" class="btn" style="flex:1;background:#ef4444;border-color:#b91c1c;display:none">Salir</button>
    </div>
    <div id="admMsg" class="muted" style="margin-top:6px;display:none"></div>
  </div>

  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    // === CONFIG (baked-in) ===
    const SB_URL  = "https://qjmugmnrgxccliyrlwfz.supabase.co";
    const SB_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqbXVnbW5yZ3hjY2xpeXJsd2Z6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3ODQzOTIsImV4cCI6MjA3MTM2MDM5Mn0.ZMM9eNBj4HQxJqZ-RKDS8YLCL20xf3geyHnLm1kGUPo";
    const BUCKET  = "imagenes"; // storage
    const FOLDERS = { portada: "portadas", lomo: "lomos" }; // destinos lógicos

    const supa = window.supabase.createClient(SB_URL, SB_ANON);
    const $ = (id)=>document.getElementById(id);
    const grid = $("grid"), status = $("status"), q = $("q");

    // Render base de 67 tomos
    const TOMOS = Array.from({length:67}, (_,i)=>i+1);
    function makeCard(n){
      const card = document.createElement("div");
      card.className = "card";
      card.dataset.tomoId = n;

      const title = document.createElement("div");
      title.className = "title";
      title.innerHTML = \`<b>Tomo \${n}</b><span class="muted">#\${n}</span>\`;

      const thumbs = document.createElement("div");
      thumbs.className = "thumbs";
      const portada = document.createElement("img"); portada.className="portada"; portada.alt = "Portada";
      const lomo = document.createElement("img"); lomo.className="lomo"; lomo.alt = "Lomo";
      thumbs.appendChild(portada); thumbs.appendChild(lomo);

      const admin = document.createElement("div");
      admin.className = "adminbar";
      admin.innerHTML = '<button class="btn primary" data-kind="portada">Subir portada</button><button class="btn warn" data-kind="lomo">Subir lomo</button>';

      admin.addEventListener("click", (ev)=>{
        const btn = ev.target.closest("button"); if(!btn) return;
        const kind = btn.dataset.kind;
        pickAndUpload(card, n, kind);
      });

      card.appendChild(title);
      card.appendChild(thumbs);
      card.appendChild(admin);
      return card;
    }

    function renderBase(){
      grid.innerHTML = "";
      TOMOS.forEach(n => grid.appendChild(makeCard(n)));
    }

    // Carga datos desde la tabla tomos (id, titulo, portada_url, lomo_url)
    async function hydrateFromDB(){
      status.textContent = "Cargando datos…";
      const { data, error } = await supa.from("tomos").select("*").order("id",{ascending:true});
      if(error){ status.textContent = "Error al cargar tomos: " + error.message; return; }
      status.textContent = "Listo";
      const map = new Map(data.map(row => [row.id, row]));
      document.querySelectorAll("[data-tomo-id]").forEach(card => {
        const id = parseInt(card.dataset.tomoId,10);
        const row = map.get(id);
        const p = card.querySelector("img.portada");
        const l = card.querySelector("img.lomo");
        if(row){
          if(row.portada_url) p.src = row.portada_url + "?t=" + Date.now();
          else p.removeAttribute("src");
          if(row.lomo_url)    l.src = row.lomo_url + "?t=" + Date.now();
          else l.removeAttribute("src");
          const title = card.querySelector(".title b");
          if(row.titulo){ title.textContent = row.titulo; }
        } else {
          p.removeAttribute("src"); l.removeAttribute("src");
        }
      });
    }

    // Buscar por números:  "1, 5, 10-12"
    function filtrar(){
      const val = q.value.trim();
      if(!val){ document.querySelectorAll(".card").forEach(c=>c.style.display=""); $("empty").style.display="none"; return; }
      const nums = new Set();
      val.split(/[ ,;]+/).forEach(tok=>{
        if(!tok) return;
        if(tok.includes("-")){
          const [a,b] = tok.split("-").map(x=>parseInt(x,10));
          if(!isNaN(a)&&!isNaN(b)){
            const lo=Math.min(a,b), hi=Math.max(a,b);
            for(let i=lo;i<=hi;i++){ if(i>=1 && i<=67) nums.add(i); }
          }
        } else {
          const n = parseInt(tok,10);
          if(!isNaN(n) && n>=1 && n<=67) nums.add(n);
        }
      });
      let visible=0;
      document.querySelectorAll(".card").forEach(c=>{
        const id = parseInt(c.dataset.tomoId,10);
        const show = nums.size===0 || nums.has(id);
        c.style.display = show ? "" : "none";
        if(show) visible++;
      });
      $("empty").style.display = visible ? "none" : "block";
    }
    $("btnBuscar").addEventListener("click", filtrar);
    q.addEventListener("keydown", (e)=>{ if(e.key==="Enter") filtrar(); });

    // Admin: login/logout y activar botones en tarjetas
    const fab = $("fab"), panel = $("panel"), admStatus = $("admStatus"), admMsg = $("admMsg");
    const email = $("email"), password = $("password"), loginBtn = $("login"), logoutBtn = $("logout");

    fab.addEventListener("click", ()=> panel.style.display = (panel.style.display==="block"?"none":"block"));

    async function refreshAdmin(){
      const { data:{ session } } = await supa.auth.getSession();
      const logged = !!session;
      admStatus.textContent = logged ? \`Sesión: \${session.user.email}\` : "No has iniciado sesión.";
      loginBtn.style.display = logged ? "none" : "inline-block";
      logoutBtn.style.display = logged ? "inline-block" : "none";
      document.querySelectorAll(".adminbar").forEach(b=> b.style.display = logged ? "flex" : "none");
    }
    loginBtn.addEventListener("click", async ()=>{
      admMsg.style.display="none";
      const { error } = await supa.auth.signInWithPassword({ email: email.value.trim(), password: password.value });
      if(error){ admMsg.textContent = "Error: "+error.message; admMsg.style.display="block"; return; }
      admMsg.textContent = "Sesión iniciada ✔"; admMsg.style.display="block";
      setTimeout(()=>admMsg.style.display="none",1500);
      refreshAdmin();
    });
    logoutBtn.addEventListener("click", async ()=>{ await supa.auth.signOut(); refreshAdmin(); });

    // Subida de archivo y actualización de la tabla
    async function pickAndUpload(card, id, kind){
      const input = document.createElement("input");
      input.type = "file"; input.accept="image/*";
      input.onchange = async (e)=>{
        const file = e.target.files?.[0]; if(!file) return;
        const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
        const folder = FOLDERS[kind] || "uploads";
        const path = `${folder}/${id}.${ext}`; // un fichero por tomo

        // subir (upsert = true sobrescribe)
        const { error: upErr } = await supa.storage.from(BUCKET).upload(path, file, { upsert:true, contentType:file.type||"image/jpeg" });
        if(upErr){ alert("Error al subir: "+upErr.message); return; }

        // url pública
        const { data } = supa.storage.from(BUCKET).getPublicUrl(path);
        const url = data.publicUrl;

        // pintar en UI (con rompe-caché)
        const img = card.querySelector(kind==="portada"? "img.portada":"img.lomo");
        if(img) img.src = url + "?t=" + Date.now();

        // upsert en la tabla
        const payload = { id };
        if(kind==="portada") payload.portada_url = url;
        else payload.lomo_url = url;

        const { error: dbErr } = await supa.from("tomos").upsert([payload], { onConflict: "id" });
        if(dbErr){ alert("Subido, pero no pude guardar en tabla: "+dbErr.message); return; }
      };
      input.click();
    }

    // init
    renderBase();
    hydrateFromDB();
    refreshAdmin();
  </script>
</body>
</html>
