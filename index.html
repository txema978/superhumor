<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Colecci√≥n Superhumor ‚Äî PWA (v2.8)</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="theme-color" content="#2563eb">
  <style>
    :root {
      --bg: #f6f7fb; --card:#fff; --text:#1f2937; --muted:#6b7280;
      --brand:#2563eb; --green:#16a34a; --red:#dc2626; --border:#e5e7eb;
    }
    * { box-sizing:border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text); background:var(--bg); }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .header { background: linear-gradient(90deg, #2563eb, #1e40af); color:#fff; border-radius: 14px; padding: 16px; display:flex; align-items:center; gap:12px; }
    .title { font-size: clamp(20px, 3vw, 26px); font-weight:800; letter-spacing:-0.02em; margin:0; }
    .sub { margin: 2px 0 0; color:#e5e7eb; }
    .grid3 { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; margin-top:12px; }
    .stat { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; }
    .stat b { font-size:22px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px; }
    .row { display:flex; gap:12px; align-items:center; }
    .seg { display:flex; gap:8px; flex-wrap:wrap; margin:12px 0; }
    .btn { border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; }
    .btn:hover { border-color:#cbd5e1; }
    .btn.brand { background: var(--brand); color:#fff; border-color:transparent; }
    .btn.green { background: var(--green); color:#fff; border-color:transparent; }
    .btn.red { background: var(--red); color:#fff; border-color:transparent; }
    .seg .btn { padding:6px 10px; font-size:14px; }
    .seg .btn.active { background:var(--brand); color:#fff; border-color:transparent; }
    .small { font-size:12px; color:var(--muted); }
    input[type="text"]{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); outline:none; }
    input[type="text"]:focus{ border-color:#cbd5e1; }
    .results { background: var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; margin:12px 0; }
    .badge { display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#fff; color:#6b7280; }
    .badge.ok { border-color:#86efac; color:#166534; background:#f0fdf4; }
    .badge.no { border-color:#fecaca; color:#7f1d1d; background:#fef2f2; }
    .cards { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; }
    @media (max-width: 960px) { .cards { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 640px) { .cards { grid-template-columns: 1fr; } }
    .progress { background:#e5e7eb; border-radius:999px; height:10px; overflow:hidden; }
    .progress > div { height:100%; background: linear-gradient(90deg, #22c55e, #16a34a); width:0%; transition: width .3s ease; }
    .center { text-align:center; }
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.75); display:flex; align-items:center; justify-content:center; padding:20px; }
    .modal > div { position:relative; max-width: 90vw; max-height:90vh; }
    .modal img { max-width:90vw; max-height:90vh; border-radius:12px; display:block; }
    .close { position:absolute; right:8px; top:8px; }

    /* Image frames */
    .img-frame { position:relative; width:100%; background:#f9fafb; border:1px dashed #d1d5db; border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .img-frame img { max-width:100%; max-height:100%; object-fit:contain; display:block; }

    /* Side-by-side cover+spine */
    .cover-spine { display:flex; gap:6px; align-items:stretch; }
    .cover-col { flex: 1 1 220px; min-width: 180px; }
    .spine-col { flex: 0 0 50px; width: 50px; }
    .spine-col .img-frame { aspect-ratio: 1 / 6; }
    .cover-col .img-frame { aspect-ratio: 3 / 4; }

    .thumb-tools { position:absolute; right:6px; top:6px; display:flex; gap:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div style="font-size:26px">üìö</div>
      <div>
        <h1 class="title">Colecci√≥n Superhumor</h1>
        <div class="sub">Gestiona tu colecci√≥n completa de 67 tomos ‚Äî v2.8</div>
      </div>
    </div>

    <div class="grid3">
      <div class="stat"><div class="small">Tomos que tienes</div><b id="st-tengo">0</b></div>
      <div class="stat"><div class="small">Tomos que faltan</div><b id="st-faltan">67</b></div>
      <div class="stat"><div class="small">Completado</div><b id="st-pct">0%</b></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row">
        <input id="in-busqueda" type="text" placeholder="Escribe n√∫meros (ej: 5, 12, 23-25, 30)"/>
        <button class="btn brand" id="btn-buscar">Buscar</button>
      </div>
      <div class="small">Puedes buscar uno o varios n√∫meros separados por comas, espacios o guiones.</div>
    </div>

    <div id="box-resultados" class="results" style="display:none">
      <div class="row" style="justify-content:space-between">
        <h4 style="margin:0" id="res-title">Resultados de b√∫squeda</h4>
        <button class="btn" id="btn-cerrar-res">‚úñ Cerrar</button>
      </div>
      <div id="res-cards" class="cards" style="margin-top:10px"></div>
    </div>

    <div class="seg">
      <button class="btn active" data-filtro="todos">Todos (67)</button>
      <button class="btn" data-filtro="tengo">Que tengo (0)</button>
      <button class="btn" data-filtro="faltan">Que me faltan (67)</button>
    </div>

    <div id="cards" class="cards"></div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <span class="small">Progreso de la colecci√≥n</span>
        <span class="small" id="st-cont">0 de 67 tomos</span>
      </div>
      <div class="progress"><div id="bar" style="width:0%"></div></div>
    </div>
  </div>

  <script>
    // Register SW with new name (v28) to nuke old cache
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker-v28.js').catch(()=>{});
      });
    }

    const $ = (s, el=document) => el.querySelector(s);
    const h = (html) => { const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; };

    function parseBusqueda(text) {
      const parts = text.split(/[,\s]+/).filter(Boolean);
      const out = new Set();
      for (const p of parts) {
        if (/^\d+-\d+$/.test(p)) {
          const [a, b] = p.split("-").map(n => parseInt(n, 10));
          if (Number.isInteger(a) && Number.isInteger(b) && a <= b) {
            for (let i=a;i<=b;i++) out.add(i);
          }
        } else if (/^\d+$/.test(p)) {
          out.add(parseInt(p, 10));
        }
      }
      return [...out].filter(n => n>=1 && n<=67).sort((x,y)=>x-y);
    }

    const STORAGE_KEY = "superhumor_v2";
    const state = { tomos:{}, filtro:"todos", busqueda:"", resultados:[], showResultados:false, fotoGrande:null };

    function load() { try { const raw=localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):null; } catch(e){ return null; } }
    function save() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify({tomos:state.tomos})); } catch(e){} }

    function init() {
      const saved = load();
      if (saved && saved.tomos) state.tomos = saved.tomos;
      else { for (let i=1;i<=67;i++) state.tomos[i] = { tengo:false, comentario:"", portada:null, lomo:null }; }
      render();
    }

    function stats() {
      const tengo = Object.values(state.tomos).filter(t=>t.tengo).length;
      return { tengo, faltan:67-tengo, pct: Math.round((tengo/67)*100) };
    }

    function renderStats() {
      const s = stats();
      $('#st-tengo').textContent = s.tengo;
      $('#st-faltan').textContent = s.faltan;
      $('#st-pct').textContent = s.pct + '%';
      $('#st-cont').textContent = s.tengo + ' de 67 tomos';
      const seg = document.querySelectorAll('.seg .btn');
      seg.forEach(btn => {
        const f = btn.getAttribute('data-filtro');
        btn.classList.toggle('active', f === state.filtro);
        if (f==='tengo') btn.textContent = 'Que tengo ('+s.tengo+')';
        if (f==='faltan') btn.textContent = 'Que me faltan ('+s.faltan+')';
      });
      $('#bar').style.width = (s.tengo/67*100).toFixed(2)+'%';
    }

    function cardHTML(num, tomo) {
      return `
        <div class="card" data-num="${num}">
          <h3 style="margin-top:0">Tomo ${num}</h3>
          <div class="row" style="gap:8px">
            <button class="btn ${tomo.tengo?'green':''}" data-action="toggle">${tomo.tengo?'‚úì Lo tengo':'Marcar como tengo'}</button>
            <span class="badge ${tomo.tengo?'ok':'no'}">${tomo.tengo?'‚úì LO TIENES':'‚úó TE FALTA'}</span>
          </div>

          ${tomo.tengo ? `
          <div class="cover-spine" style="margin-top:8px">
            <div class="cover-col">
              <div class="small" style="margin:6px 0">Portada (completa)</div>
              ${tomo.portada ? `
                <div class="img-frame">
                  <img src="${tomo.portada}" alt="Portada tomo ${num}" />
                  <div class="thumb-tools">
                    <button class="btn" data-action="ver-portada" title="Ver grande">üëÅÔ∏è</button>
                    <button class="btn red" data-action="eliminar-portada" title="Eliminar">üóëÔ∏è</button>
                  </div>
                </div>
              ` : `
                <label class="img-frame" style="cursor:pointer" title="Subir portada">
                  <input type="file" accept="image/*" style="display:none" data-action="subir-portada"/>
                  <div class="center" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:8px;color:#6b7280;">
                    <span>üì∑</span><span>Subir portada</span>
                  </div>
                </label>
              `}
            </div>
            <div class="spine-col">
              <div class="small" style="margin:6px 0">Lomo</div>
              ${tomo.lomo ? `
                <div class="img-frame">
                  <img src="${tomo.lomo}" alt="Lomo tomo ${num}" />
                  <div class="thumb-tools">
                    <button class="btn" data-action="ver-lomo" title="Ver grande">üëÅÔ∏è</button>
                    <button class="btn red" data-action="eliminar-lomo" title="Eliminar">üóëÔ∏è</button>
                  </div>
                </div>
              ` : `
                <label class="img-frame" style="cursor:pointer" title="Subir lomo">
                  <input type="file" accept="image/*" style="display:none" data-action="subir-lomo"/>
                  <div class="center" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;gap:8px;color:#6b7280;">
                    <span>üì∑</span><span>Subir lomo</span>
                  </div>
                </label>
              `}
            </div>
          </div>
          ` : ''}

          <div style="margin-top:10px">
            <div class="small" style="margin-bottom:6px">Comentario</div>
            <div data-editable="wrap">
              ${tomo._editando ? `
                <textarea data-editable="textarea">${(tomo.comentario||'').replace(/[&<>]/g,'')}</textarea>
                <div class="row" style="gap:8px; margin-top:6px">
                  <button class="btn brand" data-action="guardar-comentario">üíæ Guardar</button>
                  <button class="btn" data-action="cancelar-comentario">Cancelar</button>
                </div>
              ` : `
                <div class="small" data-action="editar-comentario" style="cursor:pointer; ${tomo.comentario?'white-space:pre-wrap':''}">
                  ${tomo.comentario ? (tomo.comentario.replace(/[&<>]/g,'')) : '<span style="font-style:italic;color:#9ca3af">Haz clic para a√±adir comentario‚Ä¶</span>'}
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function cardHTMLBusqueda(t) {
      return `
        <div class="card">
          <h3 style="margin-top:0">Tomo ${t.numero}</h3>
          <div>${t.tengo ? '<span class="badge ok">‚úì LO TIENES</span>' : '<span class="badge no">‚úó TE FALTA</span>'}</div>
          <div class="cover-spine" style="margin-top:8px">
            <div class="cover-col">
              ${t.portada ? `
                <div class="img-frame">
                  <img src="${t.portada}" alt="Portada tomo ${t.numero}" />
                </div>` : `
                <div class="img-frame"><div class="small" style="color:#9ca3af">Sin portada</div></div>`}
            </div>
            <div class="spine-col">
              ${t.lomo ? `
                <div class="img-frame">
                  <img src="${t.lomo}" alt="Lomo tomo ${t.numero}" />
                </div>` : `
                <div class="img-frame"><div class="small" style="color:#9ca3af">Sin lomo</div></div>`}
            </div>
          </div>
          ${t.comentario ? `<div class="small" style="white-space:pre-wrap;margin-top:6px">‚Äú${t.comentario.replace(/[&<>]/g,'')}‚Äù</div>` : ``}
        </div>
      `;
    }

    function render() {
      renderStats();
      const entries = Object.entries(state.tomos).filter(([n,t]) => state.filtro==='tengo'?t.tengo : state.filtro==='faltan'?!t.tengo : true);
      $('#cards').innerHTML = entries.map(([num, tomo]) => cardHTML(num, tomo)).join('');
    }

    function buscar() {
      const nums = parseBusqueda(state.busqueda);
      if (nums.length === 0) { state.resultados=[]; state.showResultados=false; $('#box-resultados').style.display='none'; return; }
      state.resultados = nums.map(n => ({ numero:n, ...state.tomos[n] }));
      $('#res-title').textContent = 'Resultados de b√∫squeda ('+state.resultados.length+' tomos)';
      $('#res-cards').innerHTML = state.resultados.map(cardHTMLBusqueda).join('');
      $('#box-resultados').style.display='block';
    }

    // Events
    document.addEventListener('click', (e) => {
      const actionEl = e.target.closest('[data-action]');
      const card = e.target.closest('.card[data-num]');
      const num = card ? parseInt(card.getAttribute('data-num'),10) : null;
      if (actionEl) {
        const action = actionEl.getAttribute('data-action');
        if (action==='toggle' && num){ state.tomos[num].tengo=!state.tomos[num].tengo; save(); render(); return; }
        if (action==='ver-portada' && num){ showModal(state.tomos[num].portada); return; }
        if (action==='eliminar-portada' && num){ state.tomos[num].portada=null; save(); render(); return; }
        if (action==='ver-lomo' && num){ showModal(state.tomos[num].lomo); return; }
        if (action==='eliminar-lomo' && num){ state.tomos[num].lomo=null; save(); render(); return; }
        if (action==='editar-comentario' && num){ state.tomos[num]._editando=true; render(); return; }
        if (action==='guardar-comentario' && num){ const ta=card.querySelector('[data-editable="textarea"]'); state.tomos[num].comentario=ta.value; state.tomos[num]._editando=false; save(); render(); return; }
        if (action==='cancelar-comentario' && num){ state.tomos[num]._editando=false; render(); return; }
      }
      const filtroBtn = e.target.closest('[data-filtro]');
      if (filtroBtn) { state.filtro = filtroBtn.getAttribute('data-filtro'); document.querySelectorAll('.seg .btn').forEach(b=>b.classList.remove('active')); filtroBtn.classList.add('active'); render(); }
      const cerrar = e.target.closest('#btn-cerrar-res');
      if (cerrar) { $('#box-resultados').style.display='none'; state.resultados=[]; state.busqueda=''; $('#in-busqueda').value=''; }
      const buscarBtn = e.target.closest('#btn-buscar');
      if (buscarBtn) { buscar(); }
    });

    document.addEventListener('change', (e) => {
      const fileInput = e.target.closest('input[type="file"][data-action]');
      if (!fileInput) return;
      const card = e.target.closest('.card[data-num]');
      const num = card ? parseInt(card.getAttribute('data-num'),10) : null;
      const act = fileInput.getAttribute('data-action');
      if (num && fileInput.files && fileInput.files[0] && fileInput.files[0].type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = ev => {
          if (act==='subir-portada') state.tomos[num].portada = ev.target.result;
          if (act==='subir-lomo') state.tomos[num].lomo = ev.target.result;
          save(); render();
        };
        reader.readAsDataURL(fileInput.files[0]);
      }
    });

    $('#in-busqueda').addEventListener('input', e => { state.busqueda = e.target.value; });
    $('#in-busqueda').addEventListener('keydown', e => { if (e.key==='Enter') buscar(); });

    function showModal(src) {
      if (!src) return;
      const modal = h('<div class="modal"><div><button class="btn close">‚úñ</button><img src="'+src+'" alt="Imagen"/></div></div>');
      modal.addEventListener('click', () => modal.remove());
      modal.querySelector('.close').addEventListener('click', () => modal.remove());
      document.body.appendChild(modal);
    }

    init();
  </script>
</body>
</html>
